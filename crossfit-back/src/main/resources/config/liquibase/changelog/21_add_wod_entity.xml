<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<property name="now" value="now()" dbms="mysql,h2" />
	<property name="now" value="current_timestamp" dbms="postgresql" />
	<property name="now" value="sysdate" dbms="oracle" />

	<property name="autoIncrement" value="true" dbms="mysql,h2,postgresql" />
	<property name="autoIncrement" value="false" dbms="oracle" />

	<property name="now" value="now()" dbms="mysql,h2" />
	<property name="now" value="current_timestamp" dbms="postgresql" />
	<property name="now" value="sysdate" dbms="oracle" />

	<property name="autoIncrement" value="true" dbms="mysql,h2,postgresql" />
	<property name="autoIncrement" value="false" dbms="oracle" />

	<property name="floatType" value="real" dbms="postgresql, h2" />
	<property name="floatType" value="float" dbms="mysql, oracle" />


	<changeSet id="201805242028" author="lgangloff">

		<createTable tableName="WOD">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="box_id" type="bigint">
				<constraints nullable="false" />
			</column>

			<column name="name" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="category" type="varchar(32)">
				<constraints nullable="false" />
			</column>
			<column name="score" type="varchar(32)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(1024)">
				<constraints nullable="false" />
			</column>
			<column name="link" type="varchar(512)">
				<constraints nullable="true" />
			</column>
			<column name="video_link" type="varchar(512)">
				<constraints nullable="true" />
			</column>

			<column name="created_by" type="varchar(100)">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false" />
			</column>
			<column name="last_modified_by" type="varchar(50)" />
			<column name="last_modified_date" type="timestamp" />
		</createTable>
		
        <addForeignKeyConstraint baseColumnNames="box_id"
                                 baseTableName="WOD"
                                 constraintName="fk_wod_box_id"
                                 referencedColumnNames="id"
                                 referencedTableName="CROSSFITBOX"/>
                                 
                                 
                                 
		<createTable tableName="EQUIPMENT">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="shortname" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="fullname" type="varchar(255)">
				<constraints nullable="false" />
			</column>

			<column name="created_by" type="varchar(100)">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false" />
			</column>
			<column name="last_modified_by" type="varchar(50)" />
			<column name="last_modified_date" type="timestamp" />
		</createTable>

		<addUniqueConstraint columnNames="fullname" tableName="EQUIPMENT" constraintName="uk_equipment_fullname"/>
		<addUniqueConstraint columnNames="shortname" tableName="EQUIPMENT" constraintName="uk_equipment_shortname"/>
		
		<createTable tableName="MOVEMENT">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="type" type="varchar(32)">
				<constraints nullable="false" />
			</column>

			<column name="shortname" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="fullname" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			
			<column name="link" type="varchar(512)">
				<constraints nullable="true" />
			</column>
			<column name="video_link" type="varchar(512)">
				<constraints nullable="true" />
			</column>

			<column name="created_by" type="varchar(100)">
				<constraints nullable="false" />
			</column>
			<column name="created_date" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false" />
			</column>
			<column name="last_modified_by" type="varchar(50)" />
			<column name="last_modified_date" type="timestamp" />
		</createTable>
		
		<addUniqueConstraint columnNames="fullname" tableName="MOVEMENT" constraintName="uk_movement_fullname"/>
		<addUniqueConstraint columnNames="shortname" tableName="MOVEMENT" constraintName="uk_movement_shortname"/>
		
		
        <createTable tableName="WOD_MOVEMENT">
            <column name="wod_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="movement_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="wod_id, movement_id" tableName="WOD_MOVEMENT"/>

        <addForeignKeyConstraint baseColumnNames="wod_id"
                                 baseTableName="WOD_MOVEMENT"
                                 constraintName="fk_wod_movement_wod_id"
                                 referencedColumnNames="id"
                                 referencedTableName="WOD"/>

        <addForeignKeyConstraint baseColumnNames="movement_id"
                                 baseTableName="WOD_MOVEMENT"
                                 constraintName="fk_wod_movement_movement_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MOVEMENT"/>
                                 
                                 
		
        <createTable tableName="WOD_EQUIPMENT">
            <column name="wod_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="equipment_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="wod_id, equipment_id" tableName="WOD_EQUIPMENT"/>

        <addForeignKeyConstraint baseColumnNames="wod_id"
                                 baseTableName="WOD_EQUIPMENT"
                                 constraintName="fk_wod_equipment_wod_id"
                                 referencedColumnNames="id"
                                 referencedTableName="WOD"/>

        <addForeignKeyConstraint baseColumnNames="equipment_id"
                                 baseTableName="WOD_EQUIPMENT"
                                 constraintName="fk_wod_equipment_equipment_id"
                                 referencedColumnNames="id"
                                 referencedTableName="EQUIPMENT"/>
                                 
                                 
		<loadData encoding="ISO-8859-1"
		            file="config/liquibase/changelog/21_add_wod_datas/movement.csv"
		            schemaName="public"
		            separator=";"
		            tableName="MOVEMENT">
		    </loadData> 
		<loadData encoding="ISO-8859-1"
		            file="config/liquibase/changelog/21_add_wod_datas/equipment.csv"
		            schemaName="public"
		            separator=";"
		            tableName="EQUIPMENT">
	    </loadData>
	    
	    
	    
	    
	    
	    
	    
	    
	    
	    
		<createTable tableName="WOD_PUBLICATION">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="wod_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="date" type="date">
				<constraints nullable="false" />
			</column>
			
		</createTable>
		
        <addForeignKeyConstraint baseColumnNames="wod_id"
                                 baseTableName="WOD_PUBLICATION"
                                 constraintName="fk_wod_publication_wod_id"
                                 referencedColumnNames="id"
                                 referencedTableName="WOD"/>
                                 
		
		<addUniqueConstraint columnNames="wod_id,date" tableName="WOD_PUBLICATION" constraintName="uk_wod_publication_wod_id_wod_date"/>
		
		
		
		
	    
		<createTable tableName="WOD_RESULT">
			<column name="id" type="bigint" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="wod_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="member_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="date" type="date">
				<constraints nullable="false" />
			</column>
			
			<column name="total_load_in_kilo" type="decimal(10,2)" />
			<column name="total_minute" type="int" />
			<column name="total_second" type="int" />
			<column name="total_complete_round" type="int" />
			<column name="total_reps" type="int" />
			
			
		</createTable>
		
        <addForeignKeyConstraint baseColumnNames="wod_id"
                                 baseTableName="WOD_RESULT"
                                 constraintName="fk_wod_result_wod_id"
                                 referencedColumnNames="id"
                                 referencedTableName="WOD"/>
        <addForeignKeyConstraint baseColumnNames="member_id"
                                 baseTableName="WOD_RESULT"
                                 constraintName="fk_wod_result_member_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MEMBER"/>
                                 
		
		<addUniqueConstraint columnNames="wod_id,member_id,date" tableName="WOD_RESULT" constraintName="uk_wod_result_wod_id_member_id_date"/>
		
	</changeSet>

</databaseChangeLog>
